---
layout: post
title:  "low爆炸了"
date:   2015-05-21 18:17:36
categories: share
---

&nbsp;&nbsp;一个low爆炸的case，今天梳理代码时才发现。

&nbsp;&nbsp;逻辑很简单，类似抽奖获取红包的功能，最初在实现的时候，为了限制系统每天抽奖送出去的钱的    
总额，在数据库中建了一个奖金池表（一定是脑袋抽了），表中只存一条记录，包含奖金上限和当天    
发出去的奖金总额，用户每次中奖之后，会做一系列比如给用户加积分等数据库操作，最后把奖金池    
的当前奖金数做一个update，为了避免数据产生不一致，这些数据库操作都放在了事务中进行，最近    
时不时的在各个server端发现too many connections的错误日志，一开始没有特别在意，直到昨天由于    
mysql主库的连接数一直处于打满状态，各个服务都收到了影响，show processlist发现都被大量的链    
接都在处理这个事务才发现问题。

&nbsp;&nbsp;由于事务中要update这条奖金池的记录，update时会锁住这条记录，其他的事务就被阻塞了，导致    
链接被大量的占用，正常的服务模块受到影响。改为直接把奖金数直接放内存或redis中做累加操作就    
ok了。

&nbsp;&nbsp;产品开发初期，代码里有不少的“临时解决方案“，后面逐步忽略了这些问题，导致流量上来以后开始    
各种补漏洞，也是醉了。
